import os
import numpy as np
import pytest

from .utils import TestUtils
from pyomeca import Markers


@pytest.mark.parametrize(
    "bionc_type",
    [
        "numpy",
        "casadi",
    ],
)
def test_biomech_model(bionc_type):
    bionc = TestUtils.bionc_folder()
    module = TestUtils.load_module(bionc + "/examples/model_creation/main.py")

    # Generate c3d file
    filename = module.generate_c3d_file()
    # Generate model
    model = module.model_creation_from_measured_data(filename)

    markers = Markers.from_c3d(filename).to_numpy()

    # delete c3d file
    os.remove(filename)

    Q1 = model.Q_from_markers(markers[:, :, 0:1])
    Q2 = model.Q_from_markers(markers[:, :, 1:2])

    with pytest.raises(
        ValueError,
        # match="markers should have 11 columns, and should include the following markers: "
        #       "['RFWT', 'LFWT', 'RBWT', 'LBWT', 'RKNI', 'RKNE', 'RANE', 'RANI', 'RHEE', 'RTARI', 'RTAR']"
    ):
        model.Q_from_markers(markers[:, 0:2, 0:1])

    # Test Q
    TestUtils.assert_equal(
        Q1,
        np.array([[-0.98789268],
                    [-0.07031773],
                    [-0.13828766],
                    [ 0.38215183],
                    [ 1.2330808 ],
                    [ 0.94343159],
                    [ 0.25266419],
                    [ 1.30339712],
                    [ 0.84530961],
                    [-0.00298463],
                    [ 0.99993838],
                    [ 0.0106923 ],
                    [-0.9950564 ],
                    [ 0.0469065 ],
                    [-0.08753592],
                    [ 0.25266419],
                    [ 1.30339712],
                    [ 0.84530961],
                    [ 0.28930181],
                    [ 1.34879082],
                    [ 0.45315924],
                    [ 0.00811241],
                    [ 0.91687414],
                    [ 0.39909396],
                    [-0.95226569],
                    [ 0.28770565],
                    [-0.10205645],
                    [ 0.28930181],
                    [ 1.34879082],
                    [ 0.45315924],
                    [ 0.34153934],
                    [ 1.3989895 ],
                    [ 0.10725695],
                    [ 0.29702757],
                    [ 0.95040448],
                    [-0.09222765],
                    [-0.95137254],
                    [ 0.19302314],
                    [-0.24006741],
                    [ 0.34153934],
                    [ 1.3989895 ],
                    [ 0.10725695],
                    [ 0.22973309],
                    [ 1.4307934 ],
                    [ 0.03157961],
                    [ 0.06437149],
                    [ 0.99783806],
                    [ 0.01324835]])
,
    )

    TestUtils.assert_equal(
        Q2,
        np.array([[-9.89579688e-01],
                    [-6.59345441e-02],
                    [-1.28002645e-01],
                    [ 3.96191359e-01],
                    [ 1.23630732e+00],
                    [ 9.43076342e-01],
                    [ 2.66311198e-01],
                    [ 1.30696092e+00],
                    [ 8.45995743e-01],
                    [ 7.79138828e-04],
                    [ 9.99980402e-01],
                    [ 6.21192187e-03],
                    [-9.96265786e-01],
                    [ 4.06880998e-02],
                    [-7.61509228e-02],
                    [ 2.66311198e-01],
                    [ 1.30696092e+00],
                    [ 8.45995743e-01],
                    [ 2.98088655e-01],
                    [ 1.34961945e+00],
                    [ 4.53051075e-01],
                    [ 7.39409947e-03],
                    [ 9.18962965e-01],
                    [ 3.94274519e-01],
                    [-9.57439447e-01],
                    [ 2.76074919e-01],
                    [-8.42160548e-02],
                    [ 2.98088655e-01],
                    [ 1.34961945e+00],
                    [ 4.53051075e-01],
                    [ 3.42664570e-01],
                    [ 1.39847636e+00],
                    [ 1.06435806e-01],
                    [ 2.83206996e-01],
                    [ 9.54874273e-01],
                    [-8.94925744e-02],
                    [-9.52711235e-01],
                    [ 1.91980261e-01],
                    [-2.35552293e-01],
                    [ 3.42664570e-01],
                    [ 1.39847636e+00],
                    [ 1.06435806e-01],
                    [ 2.29804464e-01],
                    [ 1.43074578e+00],
                    [ 3.18061858e-02],
                    [ 6.43982859e-02],
                    [ 9.97844492e-01],
                    [ 1.26186865e-02]]),
    )

    TestUtils.assert_equal(
        model.markers(Q1),
        np.array([[[0.18439544],
        [0.18508391],
        [0.38178631],
        [0.38251735],
        [0.25266419],
        [0.25316215],
        [0.25266419],
        [0.28976313],
        [0.2888405 ],
        [0.28930181],
        [0.28930181],
        [0.35611461],
        [0.32696406],
        [0.34153934],
        [0.41688827],
        [0.22581482],
        [0.23365135],
        [0.34153934]],
       [[1.33435776],
        [1.10370044],
        [1.28054621],
        [1.18561539],
        [1.30339712],
        [1.13656419],
        [1.30339712],
        [1.40092926],
        [1.29665239],
        [1.34879082],
        [1.34879082],
        [1.44562627],
        [1.35235273],
        [1.3989895 ],
        [1.39282165],
        [1.37005542],
        [1.49153139],
        [1.3989895 ]],
       [[0.91703055],
        [0.91456414],
        [0.94539987],
        [0.9414633 ],
        [0.84530961],
        [0.84352568],
        [0.84530961],
        [0.47585389],
        [0.4304646 ],
        [0.45315924],
        [0.45315924],
        [0.10273129],
        [0.1117826 ],
        [0.10725695],
        [0.07880597],
        [0.03077319],
        [0.03238603],
        [0.10725695]]]),
    )
